<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RTI Data Distribution Service C API: FlowController Use Cases</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>FlowController Use Cases<br>
<small>
[<a class="el" href="group__DDSHowToModule.html">Programming How-To's</a>]</small>
</h1>Working with flow controllers.  
<a href="#_details">More...</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
</table>
<h2><a class="anchor" name="DDSFlowControllerExampleModule_setup">
Creating a flow controller</a></h2>
<ul>
<li><a class="el" href="group__DDSParticipantExampleModule.html#DDSParticipantExampleModule_setup">Set up participant</a></li></ul>
<p>
<ul>
<li>Create a flow controller <div class="fragment"><pre class="fragment">    <a class="code" href="group__DDSReturnTypesModule.html#ga13">DDS_ReturnCode_t</a> retcode;
    <a class="code" href="group__DDSFlowControllerModule.html#ga3">DDS_FlowController</a> *controller = NULL;
    <span class="keyword">struct </span><a class="code" href="structDDS__FlowControllerProperty__t.html">DDS_FlowControllerProperty_t</a> property = <a class="code" href="group__DDSFlowControllerModule.html#ga9">DDS_FlowControllerProperty_t_INITIALIZER</a>;
    
    retcode = <a class="code" href="group__DDSDomainParticipantModule.html#ga19">DDS_DomainParticipant_get_default_flowcontroller_property</a>(
        participant, &amp;property);
    
    <span class="keywordflow">if</span> (retcode != <a class="code" href="group__DDSReturnTypesModule.html#gga13a0">DDS_RETCODE_OK</a>) {
        printf(<span class="stringliteral">"***Error: failed to get default flow controller property\n"</span>);
    }
    
    <span class="comment">/* optionally modify flow controller property values */</span>
    
    controller = <a class="code" href="group__DDSDomainParticipantModule.html#ga35">DDS_DomainParticipant_create_flowcontroller</a>(
        participant, <span class="stringliteral">"my flow controller name"</span>, &amp;property);
    
    <span class="keywordflow">if</span> (controller == NULL) {
        printf(<span class="stringliteral">"***Error: failed to create flow controller\n"</span>);
    }
</pre></div></li></ul>
<h2><a class="anchor" name="DDSFlowControllerExampleModule_using">
Flow controlling a data writer</a></h2>
<ul>
<li><a class="el" href="group__DDSParticipantExampleModule.html#DDSParticipantExampleModule_setup">Set up participant</a></li></ul>
<p>
<ul>
<li><a class="el" href="group__DDSFlowControllerExampleModule.html#DDSFlowControllerExampleModule_setup">Create flow controller</a></li></ul>
<p>
<ul>
<li>Create an asynchronous data writer, <a class="el" href="structFooDataWriter.html">FooDataWriter</a>, of user data type <code><a class="el" href="structFoo.html">Foo</a>:</code> <div class="fragment"><pre class="fragment">    <span class="keyword">struct </span><a class="code" href="structDDS__DataWriterQos.html">DDS_DataWriterQos</a> writer_qos = <a class="code" href="group__DDSWriterModule.html#ga65">DDS_DataWriterQos_INITIALIZER</a>;
    <a class="code" href="group__DDSWriterModule.html#ga0">DDS_DataWriter</a>* writer;
    <span class="keyword">struct </span><a class="code" href="structDDS__DataWriterListener.html">DDS_DataWriterListener</a> writer_listener =
        <a class="code" href="group__DDSWriterModule.html#ga66">DDS_DataWriterListener_INITIALIZER</a>;

    <span class="comment">/* MyWriterListener_* functions are user defined to match</span>
<span class="comment">       DDS_DataWriterListener functions */</span>
    writer_listener.<a class="code" href="structDDS__DataWriterListener.html#o1">on_offered_deadline_missed</a> =
        MyWriterListener_OfferedDeadlineMissed;
    writer_listener.<a class="code" href="structDDS__DataWriterListener.html#o2">on_offered_incompatible_qos</a> =
        MyWriterListener_OfferedIncompatibleQos;
    writer_listener.<a class="code" href="structDDS__DataWriterListener.html#o3">on_liveliness_lost</a> = MyWriterListener_LivelinessLost;
    writer_listener.<a class="code" href="structDDS__DataWriterListener.html#o4">on_publication_matched</a> = MyWriterListener_PublicationMatch;

    retcode = <a class="code" href="group__DDSPublisherModule.html#ga7">DDS_Publisher_get_default_datawriter_qos</a>(publisher, &amp;writer_qos);

    <span class="keywordflow">if</span> (retcode != <a class="code" href="group__DDSReturnTypesModule.html#gga13a0">DDS_RETCODE_OK</a>) {
        printf(<span class="stringliteral">"***Error: failed to get default datawriter qos\n"</span>);
    }
    
    <span class="comment">/* Change the writer QoS to publish asnychronously */</span>
    writer_qos.<a class="code" href="structDDS__DataWriterQos.html#o20">publish_mode</a>.<a class="code" href="structDDS__PublishModeQosPolicy.html#o0">kind</a> = <a class="code" href="group__DDSPublishModeQosModule.html#gga2a324">DDS_ASYNCHRONOUS_PUBLISH_MODE_QOS</a>;

    <span class="comment">/* Setup to use the previously created flow controller */</span>
    writer_qos.<a class="code" href="structDDS__DataWriterQos.html#o20">publish_mode</a>.<a class="code" href="structDDS__PublishModeQosPolicy.html#o1">flow_controller_name</a> = 
        <a class="code" href="group__DDSStringClass.html#ga1">DDS_String_dup</a>(<span class="stringliteral">"my flow controller name"</span>);

    <span class="comment">/* Samples queued for asynchronous write are subject to the History Qos policy */</span>
    writer_qos.<a class="code" href="structDDS__DataWriterQos.html#o7">history</a>.<a class="code" href="structDDS__HistoryQosPolicy.html#o0">kind</a> = <a class="code" href="group__DDSHistoryQosModule.html#gga2a312">DDS_KEEP_ALL_HISTORY_QOS</a>;

    writer = <a class="code" href="group__DDSPublisherModule.html#ga9">DDS_Publisher_create_datawriter</a>(publisher, 
                                             topic, 
                                             &amp;writer_qos, 
                                             &amp;writer_listener <span class="comment">/* or NULL */</span>,
                                             <a class="code" href="group__DDSStatusTypesModule.html#ga2">DDS_STATUS_MASK_ALL</a>);

    <span class="keywordflow">if</span> (writer == NULL) {
        printf(<span class="stringliteral">"***Error: failed to create writer\n"</span>);
    }

    <span class="comment">/* Send data asynchronously... */</span>
    
    <span class="comment">/* Wait for asynchronous send completes, if desired */</span>
    retcode = <a class="code" href="group__DDSWriterModule.html#ga47">DDS_DataWriter_wait_for_asynchronous_publishing</a>(writer, &amp;timout);

    <span class="keywordflow">if</span> (retcode != <a class="code" href="group__DDSReturnTypesModule.html#gga13a0">DDS_RETCODE_OK</a>) {
        printf(<span class="stringliteral">"***Error: failed to wait for asynchronous publishing\n"</span>);
    }
</pre></div></li></ul>
<h2><a class="anchor" name="DDSFlowControllerExampleModule_builtin">
Using the built-in flow controllers</a></h2>
RTI Data Distribution Service provides several built-in flow controllers.<p>
The <a class="el" href="group__DDSFlowControllerModule.html#ga0">DDS_DEFAULT_FLOW_CONTROLLER_NAME</a> built-in flow controller provides the basic asynchronous writer behavior. When calling <a class="el" href="group__DDSWriterModule.html#ga13">FooDataWriter_write</a>, the call signals the <a class="el" href="group__DDSPublisherModule.html#ga0">DDS_Publisher</a> asynchronous publishing thread (<a class="el" href="structDDS__PublisherQos.html#o4">DDS_PublisherQos::asynchronous_publisher</a>) to send the actual data. As with any <a class="el" href="group__DDSPublishModeQosModule.html#gga2a324">DDS_ASYNCHRONOUS_PUBLISH_MODE_QOS</a> <a class="el" href="group__DDSWriterModule.html#ga0">DDS_DataWriter</a>, the <a class="el" href="group__DDSWriterModule.html#ga13">FooDataWriter_write</a> call returns immediately afterwards. The data is sent immediately in the context of the <a class="el" href="group__DDSPublisherModule.html#ga0">DDS_Publisher</a> asynchronous publishing thread.<p>
When using the <a class="el" href="group__DDSFlowControllerModule.html#ga1">DDS_FIXED_RATE_FLOW_CONTROLLER_NAME</a> flow controller, data is also sent in the context of the <a class="el" href="group__DDSPublisherModule.html#ga0">DDS_Publisher</a> asynchronous publishing thread, but at a regular fixed interval. The thread accumulates samples from different <a class="el" href="group__DDSWriterModule.html#ga0">DDS_DataWriter</a> instances and generates data on the wire only once per <a class="el" href="structDDS__FlowControllerTokenBucketProperty__t.html#o3">DDS_FlowControllerTokenBucketProperty_t::period</a>.<p>
In contrast, the <a class="el" href="group__DDSFlowControllerModule.html#ga2">DDS_ON_DEMAND_FLOW_CONTROLLER_NAME</a> flow controller permits flow only when <a class="el" href="group__DDSFlowControllerModule.html#ga8">DDS_FlowController_trigger_flow</a> is called. The data is still sent in the context of the <a class="el" href="group__DDSPublisherModule.html#ga0">DDS_Publisher</a> asynchronous publishing thread. The thread accumulates samples from different <a class="el" href="group__DDSWriterModule.html#ga0">DDS_DataWriter</a> instances (across any <a class="el" href="group__DDSPublisherModule.html#ga0">DDS_Publisher</a>) and sends all data since the previous trigger.<p>
The properties of the built-in <a class="el" href="group__DDSFlowControllerModule.html#ga3">DDS_FlowController</a> instances can be adjusted.<p>
<ul>
<li><a class="el" href="group__DDSParticipantExampleModule.html#DDSParticipantExampleModule_setup">Set up participant</a></li></ul>
<p>
<ul>
<li>Lookup built-in flow controller <div class="fragment"><pre class="fragment">    <a class="code" href="group__DDSFlowControllerModule.html#ga3">DDS_FlowController</a> *controller = NULL;

    controller = <a class="code" href="group__DDSDomainParticipantModule.html#ga39">DDS_DomainParticipant_lookup_flowcontroller</a>(
        participant, <a class="code" href="group__DDSFlowControllerModule.html#ga0">DDS_DEFAULT_FLOW_CONTROLLER_NAME</a>);

    <span class="comment">/* This should never happen, built-in flow controllers are always created */</span>
    <span class="keywordflow">if</span> (controller == NULL) {
        printf(<span class="stringliteral">"***Error: failed to lookup flow controller\n"</span>);
    }
</pre></div></li></ul>
<p>
<ul>
<li>Change property of built-in flow controller, if desired <div class="fragment"><pre class="fragment">    <a class="code" href="group__DDSReturnTypesModule.html#ga13">DDS_ReturnCode_t</a> retcode;
    <span class="keyword">struct </span><a class="code" href="structDDS__FlowControllerProperty__t.html">DDS_FlowControllerProperty_t</a> property = <a class="code" href="group__DDSFlowControllerModule.html#ga9">DDS_FlowControllerProperty_t_INITIALIZER</a>;

    <span class="comment">/* Get the property of the flow controller */</span>
    retcode = <a class="code" href="group__DDSFlowControllerModule.html#ga7">DDS_FlowController_get_property</a>(controller, &amp;property);

    <span class="keywordflow">if</span> (retcode != <a class="code" href="group__DDSReturnTypesModule.html#gga13a0">DDS_RETCODE_OK</a>) {
        printf(<span class="stringliteral">"***Error: failed to get flow controller property\n"</span>);
    }

    <span class="comment">/* Change the property value as desired */</span>
    property.<a class="code" href="structDDS__FlowControllerProperty__t.html#o1">token_bucket</a>.<a class="code" href="structDDS__FlowControllerTokenBucketProperty__t.html#o3">period</a>.<a class="code" href="structDDS__Duration__t.html#o0">sec</a> = 2;
    property.<a class="code" href="structDDS__FlowControllerProperty__t.html#o1">token_bucket</a>.<a class="code" href="structDDS__FlowControllerTokenBucketProperty__t.html#o3">period</a>.<a class="code" href="structDDS__Duration__t.html#o1">nanosec</a> = 0;

    <span class="comment">/* Update the flow controller property */</span>
    retcode = <a class="code" href="group__DDSFlowControllerModule.html#ga6">DDS_FlowController_set_property</a>(controller, &amp;property);

    <span class="keywordflow">if</span> (retcode != <a class="code" href="group__DDSReturnTypesModule.html#gga13a0">DDS_RETCODE_OK</a>) {
        printf(<span class="stringliteral">"***Error: failed to set flow controller property\n"</span>);
    }
</pre></div></li></ul>
<p>
<ul>
<li><a class="el" href="group__DDSFlowControllerExampleModule.html#DDSFlowControllerExampleModule_using">Create a data writer using the correct flow controller name</a></li></ul>
<h2><a class="anchor" name="DDSFlowControllerExampleModule_trafficing">
Shaping the network traffic for a particular transport</a></h2>
<ul>
<li><a class="el" href="group__DDSParticipantExampleModule.html#DDSParticipantExampleModule_setup">Set up participant</a></li></ul>
<p>
<ul>
<li><a class="el" href="group__NDDSTransportExampleModule.html">Create the transports</a></li></ul>
<p>
<ul>
<li><a class="el" href="group__DDSFlowControllerExampleModule.html#DDSFlowControllerExampleModule_setup">Create a separate flow controller for each transport</a></li></ul>
<p>
<ul>
<li>Configure <a class="el" href="group__DDSWriterModule.html#ga0">DDS_DataWriter</a> instances to only use a single transport</li></ul>
<p>
<ul>
<li><a class="el" href="group__DDSFlowControllerExampleModule.html#DDSFlowControllerExampleModule_using">Associate all data writers using the same transport to the corresponding flow controller</a></li></ul>
<p>
<ul>
<li>For each transport, the corresponding flow controller limits the network traffic based on the token bucket properties</li></ul>
<h2><a class="anchor" name="DDSFlowControllerExampleModule_coalescing">
Coalescing multiple samples in a single network packet</a></h2>
<ul>
<li><a class="el" href="group__DDSParticipantExampleModule.html#DDSParticipantExampleModule_setup">Set up participant</a></li></ul>
<p>
<ul>
<li><a class="el" href="group__DDSFlowControllerExampleModule.html#DDSFlowControllerExampleModule_setup">Create a flow controller with a desired token bucket period</a></li></ul>
<p>
<ul>
<li><a class="el" href="group__DDSFlowControllerExampleModule.html#DDSFlowControllerExampleModule_using">Associate the data writer with the flow controller</a></li></ul>
<p>
<ul>
<li>Multiple samples written within the specified period will be coalesced into a single network packet (provided that <code>tokens_added_per_period</code> and <code>bytes_per_token</code> permit). </li></ul>
<HR>
<IMG SRC="rti_logo.gif" height="16">
<A HREF="main.html">RTI Data Distribution Service C API Version 4.2e (General Access Release)</A>
Copyright &copy; 4 Dec 2007 
<A HREF="http://www.rti.com">Real-Time Innovations, Inc</A>
</BODY>
</HTML>
