<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RTI Data Distribution Service C API: Creating Custom Content Filters</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>Creating Custom Content Filters<br>
<small>
[<a class="el" href="group__DDSHowToModule.html">Programming How-To's</a>]</small>
</h1>Working with custom content filters.  
<a href="#_details">More...</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
</table>
<h2><a class="anchor" name="NDDSCustomFilterExampleModule_intro">
Introduction</a></h2>
By default, RTI Data Distribution Service creates content filters with the DDS_SQL_FILTER, which implements a superset of the DDS-specified SQL WHERE clause. However, in many cases this filter may not be what you want. Some examples are:<p>
<ul>
<li>The default filter can only filter based on the content of a sample, not on a computation on the content of a sample. You can use a custom filter that is customized for a specific type and can filter based on a computation of the type members.</li><li>You want to use a different filter language then SQL</li></ul>
<p>
This HOWTO explains how to write your own custom filter and is divided into the following sections:<p>
<ul>
<li><a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_anatomy">The Custom Content Filter API</a></li><li><a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_using_c_format">Example Using C format strings</a></li></ul>
<h2><a class="anchor" name="NDDSCustomFilterExampleModule_anatomy">
The Custom Content Filter API</a></h2>
A custom content filter is created by calling the <a class="el" href="group__DDSDomainParticipantModule.html#ga30">DDS_DomainParticipant_register_contentfilter</a> function with a <a class="el" href="structDDS__ContentFilter.html">DDS_ContentFilter</a> that contains a <b>compile</b>, an <b>evaluate</b> function and a <b>finalize</b> function. <a class="el" href="group__DDSTopicEntityModule.html#ga3">DDS_ContentFilteredTopic</a> can be created with <a class="el" href="group__DDSDomainParticipantModule.html#ga28">DDS_DomainParticipant_create_contentfilteredtopic_with_filter</a> to use this filter.<p>
A custom content filter is used by RTI Data Distribution Service at the following times during the life-time of a <a class="el" href="group__DDSTopicEntityModule.html#ga3">DDS_ContentFilteredTopic</a> (the function called is shown in parenthesis).<p>
<ul>
<li>When a <a class="el" href="group__DDSTopicEntityModule.html#ga3">DDS_ContentFilteredTopic</a> is created (<a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_compile">compile</a>)</li><li>When the filter parameters are changed on the <a class="el" href="group__DDSTopicEntityModule.html#ga3">DDS_ContentFilteredTopic</a> (<a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_compile">compile</a>) with <a class="el" href="group__DDSTopicEntityModule.html#ga30">DDS_ContentFilteredTopic_set_expression_parameters</a></li><li>When a sample is filtered (<a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_evaluate">evaluate</a>). This function is called by the RTI Data Distribution Service core with a de-serialized sample</li><li>When a <a class="el" href="group__DDSTopicEntityModule.html#ga3">DDS_ContentFilteredTopic</a> is deleted (<a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_finalize">finalize</a>)</li></ul>
<h3><a class="anchor" name="NDDSCustomFilterExampleModule_compile">
The compile function</a></h3>
The <a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_using_c_format_compile">compile</a> function is used to <b>compile</b> a filter expression and expression parameters. Please note that the term <b>compile</b> is intentionally loosely defined. It is up to the user to decide what this function should do and return.<p>
See <a class="el" href="structDDS__ContentFilter.html#o0">DDS_ContentFilter::compile</a> for details.<h3><a class="anchor" name="NDDSCustomFilterExampleModule_evaluate">
The evaluate function</a></h3>
The <a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_using_c_format_evaluate">evaluate</a> function is called each time a sample is received to determine if a sample should be filtered out and discarded.<p>
See <a class="el" href="structDDS__ContentFilter.html#o1">DDS_ContentFilter::evaluate</a> for details.<h3><a class="anchor" name="NDDSCustomFilterExampleModule_finalize">
The finalize function</a></h3>
The <a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_using_c_format_finalize">finalize</a> function is called when an instance of the custom content filter is no longer needed. When this function is called, it is safe to free all resources used by this particular instance of the custom content filter.<p>
See <a class="el" href="structDDS__ContentFilter.html#o2">DDS_ContentFilter::finalize</a> for details.<h2><a class="anchor" name="NDDSCustomFilterExampleModule_using_c_format">
Example Using C format strings</a></h2>
Assume that you have a type <a class="el" href="structFoo.html">Foo</a>.<p>
You want to write a custom filter function that will drop all samples where the value of Foo.x &gt; x and x is a value determined by an expression parameter. The filter will <b>only</b> be used to filter samples of type <a class="el" href="structFoo.html">Foo</a>.<h3><a class="anchor" name="NDDSCustomFilterExampleModule_using_c_format_compile">
Writing the Compile Function</a></h3>
The first thing to note is that we can ignore the filter expression, since we already know what the expression is. The second is that x is a parameter that can be changed. By using this information, the compile function is very easy to implement. Simply return the parameter string. This string will then be passed to the evaluate function every time a sample of this type is filtered.<p>
Below is the entire <a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_compile">compile</a> function.<p>
<div class="fragment"><pre class="fragment">
<a class="code" href="group__DDSReturnTypesModule.html#ga13">DDS_ReturnCode_t</a>
howto_write_simple_compile_function(<span class="keywordtype">void</span> *handle,
                                    <span class="keywordtype">void</span> **new_compile_data,
                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *expression,
                                    <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structDDS__StringSeq.html">DDS_StringSeq</a> *parameters,
                                    <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structDDS__TypeCode.html">DDS_TypeCode</a> *type_code,
                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *type_class_name,
                                    <span class="keywordtype">void</span> *old_compile_data)
{
    *new_compile_data = (<span class="keywordtype">void</span>*)<a class="code" href="group__DDSStringClass.html#ga1">DDS_String_dup</a>(*DDS_StringSeq_get_reference(parameters,0));

    <span class="keywordflow">return</span> <a class="code" href="group__DDSReturnTypesModule.html#gga13a0">DDS_RETCODE_OK</a>;
}
</pre></div><h3><a class="anchor" name="NDDSCustomFilterExampleModule_using_c_format_evaluate">
Writing the Evaluate Function</a></h3>
The next step is to implement the <b>evaluate</b> function. The evaluate function receives the parameter string with the actual value to test against. Thus the evaluate function must read the actual value from the parameter string before evaluating the expression. Below is the entire <a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_evaluate">evaluate</a> function.<p>
<div class="fragment"><pre class="fragment">
<a class="code" href="group__DDSCdrTypesModule.html#ga12">DDS_Boolean</a>
howto_write_simple_evaluate_function(<span class="keywordtype">void</span> *filter_data,
                                     <span class="keywordtype">void</span> *compile_data,
                                     <span class="keyword">const</span> <span class="keywordtype">void</span> *sample)
{
    <span class="keywordtype">char</span> *parameter = (<span class="keywordtype">char</span>*)compile_data;
    <a class="code" href="group__DDSCdrTypesModule.html#ga5">DDS_Long</a> x;

    <a class="code" href="structFoo.html">Foo</a> *foo_sample = (<a class="code" href="structFoo.html">Foo</a>*)sample;

    sscanf(parameter,<span class="stringliteral">"%d"</span>,&amp;x);

    <span class="keywordflow">return</span> (foo_sample-&gt;x &gt; x ? <a class="code" href="group__DDSCdrTypesModule.html#ga15">DDS_BOOLEAN_FALSE</a> : <a class="code" href="group__DDSCdrTypesModule.html#ga14">DDS_BOOLEAN_TRUE</a>);
}
</pre></div><h3><a class="anchor" name="NDDSCustomFilterExampleModule_using_c_format_finalize">
Writing the Finalize Function</a></h3>
The last function to write is the finalize function. It is safe to free all resources used by this particular instance of the custom content filter that is allocated in <b>compile</b>. Below is the entire <a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_finalize">finalize</a> function.<p>
<div class="fragment"><pre class="fragment">
<span class="keywordtype">void</span>
howto_write_simple_finalize_function(<span class="keywordtype">void</span> *filter_data,
                                     <span class="keywordtype">void</span> *compile_data)
{
    <span class="comment">/* free parameter string from compile function */</span>
    <a class="code" href="group__DDSStringClass.html#ga2">DDS_String_free</a>((<span class="keywordtype">char</span> *)compile_data);
}
</pre></div><h3><a class="anchor" name="NDDSCustomFilterExampleModule_using_c_format_register">
Registering the Filter</a></h3>
Before the custom filter can be used, it must be registered with RTI Data Distribution Service:<p>
<div class="fragment"><pre class="fragment">
    <span class="keyword">struct </span><a class="code" href="structDDS__ContentFilter.html">DDS_ContentFilter</a> filter = <a class="code" href="group__DDSTopicEntityModule.html#ga40">DDS_ContentFilter_INITIALIZER</a>;
    filter.<a class="code" href="structDDS__ContentFilter.html#o0">compile</a> = howto_write_simple_compile_function;
    filter.<a class="code" href="structDDS__ContentFilter.html#o1">evaluate</a> = howto_write_simple_evaluate_function;
    filter.<a class="code" href="structDDS__ContentFilter.html#o2">finalize</a> = howto_write_simple_finalize_function;
    filter.<a class="code" href="structDDS__ContentFilter.html#o3">filter_data</a> = NULL;

    <span class="keywordflow">if</span> (<a class="code" href="group__DDSDomainParticipantModule.html#ga30">DDS_DomainParticipant_register_contentfilter</a>(
        participant, <span class="stringliteral">"MyCustomFilter"</span>, &amp;filter) != <a class="code" href="group__DDSReturnTypesModule.html#gga13a0">DDS_RETCODE_OK</a>) {
        printf(<span class="stringliteral">"Failed to register custom filter\n"</span>);
    }
</pre></div><h3><a class="anchor" name="NDDSCustomFilterExampleModule_using_c_format_unregister">
Unregistering the Filter</a></h3>
When the filter is no longer needed, it can be unregistered from RTI Data Distribution Service:<p>
<div class="fragment"><pre class="fragment">
    <span class="keywordflow">if</span> (<a class="code" href="group__DDSDomainParticipantModule.html#ga32">DDS_DomainParticipant_unregister_contentfilter</a>(
        participant, <span class="stringliteral">"MyCustomFilter"</span> ) != <a class="code" href="group__DDSReturnTypesModule.html#gga13a0">DDS_RETCODE_OK</a>) {
        printf(<span class="stringliteral">"Failed to unregister custom filter\n"</span>);
    }
</pre></div> <HR>
<IMG SRC="rti_logo.gif" height="16">
<A HREF="main.html">RTI Data Distribution Service C API Version 4.2e (General Access Release)</A>
Copyright &copy; 4 Dec 2007 
<A HREF="http://www.rti.com">Real-Time Innovations, Inc</A>
</BODY>
</HTML>
